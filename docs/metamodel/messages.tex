%!TEX root=../robocert.tex
\begin{figure}
	\centering
	\includegraphics[width=\textwidth]{diagrams/Messages}
	\caption{Class diagram for the part of the \langname{} metamodel dealing with messages.}
	\label{fig:metamodel-messages}
\end{figure}

\Cref{fig:metamodel-messages} depicts the part of the metamodel concerning
messages between actors.  Messages are introduced into a sequence diagram
in \mmessageset s and \marrowaction s.

\subsection{\mmessageset}\label{ssec:metamodel-messages-sets}

A \mmessageset{} is an expression of the set of messages allowed or forbidden
inside a \msequencegap.  There are two types of \mmessageset:

\begin{itemize}
\item
  a \muniversemessageset{} represents the universal set containing 
  all possible messages, and
  captures a lack of specific restriction on
  the \emph{allowed} set of a \msequencegap;
\item	
  an \mextensionalmessageset{} is a set (expressed as an unordered list) of
  zero or more \mgapmessagespec s, themselves
  a type of \mmessagespec{} (\cref{sec:metamodel-messages});
\item
  a \mrefmessageset{} refers to a \mnamedmessageset{} attached to the
  sequence.
\end{itemize}

There is not yet any meaningful extra data stored in
\mgapmessagespec s that is not present in \mmessagespec s, but this is subject
to change.

\begin{lstlisting}[style=Example]
universe                 // UniverseMessageSet
{| -> operation O1() |}  // ExtensionalMessageSet
message set S            // RefMessageSet
\end{lstlisting}

\subsection{\mnamedmessageset}\label{ssec:metamodel-messages-named-sets}

A \mnamedmessageset{} attaches a name to a \mmessageset, so that it can be reused
inside a \msequence.

\begin{lstlisting}[style=Example]
message set S: {| -> operation O1() |}
\end{lstlisting}

\subsection{\mmessagespec}

A \mmessagespec{} is a specification on the types of communication that can
happen during a gap (a \mgapmessagespec) or arrow (an \marrowmessagespec).\footnote{
This class distinction resembles that in PSCs betweeen intraMSGs and arrowMSGs,
respectively.}  Each \mmessagespec{} contains:

\begin{itemize}
\item
  a \mmessagedirection; \emph{outbound} from \mtarget{} to \mworld,
  or \emph{inbound} from \mworld to \mtarget;
\item
  the \mmessagetopic{} (\cref{ssec:metamodel-messages-topics}) specifying
  the type of communication that the spec is capturing.
\end{itemize}

It is possible to infer the \mtarget{} and \mworld{} related by a
\mmessagespec{} through its containing \msequencegroup.  From these
and the \mmessagedirection, we can further infer the source (`from')
and destination (`to') \mactor s.  The target, from, and to actors are
available in EMF as derived references.

\begin{figure}[h!]

\begin{subfigure}[t]{\egtextwidth}
\begin{lstlisting}[style=Example]
-> operation O1()
// outbound MessageSpec with OperationTopic

<- event E
// inbound MessageSpec with EventTopic
\end{lstlisting}
\end{subfigure}
\hfill
\begin{subfigure}[t]{\eggraphicalwidth}
\gsecaption
\centering
\begin{tikzpicture}
\matrix[diagram]{
    \node[rcmodule](mstart) {\egtarget}; & \node[world](wstart) {\egworld}; \\
	\coordinate(mo); & \coordinate(wo); \\
	\coordinate(me); & \coordinate(we); \\
	\coordinate(mend); & \coordinate(wend); \\
};
\draw[lifeline] (wstart) -- (wo) -- (we) -- (wend);
\draw[lifeline] (mstart) -- (mo) -- (me) -- (mend);
\draw (mo) edge[oarrow, "O1()"] (wo);
\draw (we) edge[earrow, "E"'] (me);
\end{tikzpicture}
\end{subfigure}

\end{figure}

\subsection{\mmessagetopic}\label{ssec:metamodel-messages-topics}

A \mmessagetopic{} identifies the specific type of communication in a
\mmessagespec{}.  There are currently two types of topic, corresponding to
\robochart{} operations (\moperationtopic) and events (\meventtopic)
\todo{variable topics will arrive later on; \ghissue{24}}.
Each contains a reference to the signature of the respective construct.

\begin{lstlisting}[style=Example]
operation O1() // OperationTopic
event E        // EventTopic
\end{lstlisting}

\subsection{\margument}\label{ssec:metamodel-messages-arguments}

An \margument{} is a pattern that specifies (and possibly binds) one or more
arguments in
a message.  There are two types of argument:

\begin{itemize}
\item
  \mexpressionargument, which specifies that the argument is equal to the
  value of a particular \robochart{} expression;
  \todo{the \langname{} CSP generator doesn't yet properly protect against this being
    an expression not expressible as a prefix}
\item
  \mrestargument, which matches \emph{all} following arguments and permits
  them to be any value.
  \todo{This mainly exists because it's very easy to specify in CSP.  Ideally
    we'll have something that allows wildcards on arbitrary parameters, in
    which case this might be confusing to have also.}
\end{itemize}

\margument s that introduce bindings \todo{which do not exist
  yet \todo{\ghissue{12}}} may only appear in \marrowmessagespec s.
This is because bindings are only visible during the main body of a
sequence.
Consequently, any arguments that appear in
\mgapmessagespec s must be subclasses of \mnonbindingargument.

must not introduce bindings, as
any bindings that could be introduced would not 
and
this is represented by the 

All \margument s, at time of writing, are forms of \mnonbindingargument{} and
can therefore appear in \mgapmessagespec s.  This will change when binding
arguments are introduced
\todo{\ghissue{12}}.

\begin{lstlisting}[style=Example]
42  // ExpressionArgument containing integer literal
... // RestArgument
\end{lstlisting}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../robocert"
%%% End:
