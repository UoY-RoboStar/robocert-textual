%!TEX root=../robocert.tex
\begin{figure}
	\centering
	\includegraphics[width=\textwidth]{diagrams/Sequences}
	\caption{Class diagram for the part of the \langname{} metamodel dealing with sequences.}
	\label{fig:metamodel-sequences}
\end{figure}

\Cref{fig:metamodel-sequences} depicts the part of the metamodel concerning
sequence diagrams and their high-level structure.

\subsection{\msequencegroup}

A \msequencegroup{} is a top-level container for sequence diagrams.
It is a \mnamedelement{} that contains:

\begin{itemize}
\item
  two \mactor s (\cref{sec:metamodel-actors}):
  a \mtarget{} (\cref{ssec:metamodel-actors-target})
  and a \mworld{} (\cref{ssec:metamodel-actors-world});
\item
  zero or more \mnamedmessageset{}s (\cref{ssec:metamodel-messages-named-sets});
\item
  zero or more \msequence{} (\cref{ssec:metamodel-sequences-sequences}).
\end{itemize}

\begin{lstlisting}[style=Example]
sequence group Group:
  module AModule  // RCModuleTarget actor
  -> world        // World actor
{
  message set M1: universe
  
  sequence Example1 {
    anything until end
  }
  sequence Example2 {
    anything until end
  }
}
\end{lstlisting}

\subsection{\msequence}\label{ssec:metamodel-sequences-sequences}

A \msequence{} represents a sequence diagram.  It is a \mnamedelement{}
that contains a \msubsequence{} (\cref{ssec:metamodel-sequences-subsequences})
capturing the body of the diagram.

\begin{figure}[h!]

  \begin{subfigure}[t]{\egtextwidth}
    \begin{lstlisting}[style=Example]
sequence Example {
  anything until end  // Subsequence
}
    \end{lstlisting}
  \end{subfigure}
  \hfill
  \begin{subfigure}[t]{\eggraphicalwidth}
    \gsecaption
    \centering
    \begin{tikzpicture}
      \matrix[diagram]{
        \node[rcmodule](mstart) {\egtarget}; & \node[world](wstart) {\egworld}; \\
	\coordinate(mend); & \coordinate(wend); \\
      };
      \gseq{wstart}{mstart}{wend}{mend}{Example}
      \draw[lifeline] (wstart) -- (wend);
      \draw[lifeline] (mstart) -- (mend);
      \gfinal{mend}{wend}
      \ggapout{mend}{\guniverse}
    \end{tikzpicture}
  \end{subfigure}

\end{figure}

\subsection{\msubsequence}\label{ssec:metamodel-sequences-subsequences}

A \msubsequence{} is a sequential composition of one or more \msequencestep s
(\cref{ssec:metamodel-sequences-steps}).
All \msequence s contain exactly one \msubsequence{} at the top level, but
may contain multiple nested \msubsequence s introduced by constructs such as
\mloopaction s.

\begin{figure}[h!]

  \begin{subfigure}[t]{\egtextwidth}
    \begin{lstlisting}[style=Example]
{
  anything until -> operation O1()
  // ^ SequenceStep
  then -> operation O2()
  // ^ SequenceStep
  then end
  // ^ SequenceStep
}
    \end{lstlisting}
  \end{subfigure}
  \hfill
  \begin{subfigure}[t]{\eggraphicalwidth}
    \gsecaption
    \centering
    \begin{tikzpicture}
      \matrix[diagram]{
        \node[rcmodule](mstart) {\egtarget}; & \node[world](wstart) {\egworld}; \\
	\coordinate(mo1); & \coordinate(wo1); \\
	\coordinate(mo2); & \coordinate(wo2); \\
	\coordinate(mend); & \coordinate(wend); \\
      };
      \gseq{wstart}{mstart}{wend}{mend}{Example}
      \draw[lifeline] (mstart) -- (mo1) -- (mo2) -- (mend);
      \draw[lifeline] (wstart) -- (wo1) -- (wo2) -- (wend);

      \goperation{mo1}{wo1}{O1()}
      \ggapout{mo1}{\guniverse}
      \goperation{mo2}{wo2}{O2()}
      
      \gfinal{mend}{wend}

    \end{tikzpicture}
  \end{subfigure}

\end{figure}

\subsection{\msequencestep}\label{ssec:metamodel-sequences-steps}

A \msequencestep{} is a single step in a \msubsequence.  It consists of a
\msequencegap{} (\cref{ssec:metamodel-sequences-gaps}) and a
\msequenceaction{} (\cref{sec:metamodel-actions}).

\begin{lstlisting}[style=Example]
anything until -> operation O()
// SequenceStep with explicit SequenceGap and SequenceAction

-> operation O()
// SequenceStep with explicit SequenceAction only;
// implicit SequenceGap with empty allow set
\end{lstlisting}

\subsection{\msequencegap}\label{ssec:metamodel-sequences-gaps}

A \msequencegap{} represents a condition on any
communication\footnote{In PSCs, this would correspond to
  \emph{intraMSG}s.} that can happen \emph{before} a \msequenceaction.
It contains two \mmessageset s (\cref{ssec:metamodel-messages-sets}):
one specifying the messages \emph{allowed} to pass inside the gap, and
another specifying the messages \emph{forbidden} to pass.

\begin{figure}[h!]

  \begin{subfigure}[c]{\egtextwidth}
    \begin{lstlisting}[style=Example]
anything
in message set MS
except {| -> operation O2() |}
until

anything in message set MS until
// implicit 'except {||}'

anything until
// implicit 'in universe {||}'
\end{lstlisting}
  \end{subfigure}
  \hfill
  \begin{subfigure}[c]{\eggraphicalwidth}
    \gsecaption
    \centering
    \begin{tikzpicture}
      \matrix[diagram, column sep=15em]{
        \coordinate(m1); & \coordinate(w1); \\
        \coordinate(m2); & \coordinate(w2); \\
        \coordinate(m3); & \coordinate(w3); \\
      };
      \draw[dotted] (m1) -- (w1);
      \ggapout{m1}{\gdiff{\grefset{MS}}\gextset{\text{\lstinline[language=RoboCert]{-> operation O2()}}}}
      
      \draw[dotted] (m2) -- (w2);
      \ggapin{w2}{\grefset{MS}}
      
      \draw[dotted] (m3) -- (w3);
      \ggapout{m3}{\guniverse}
    \end{tikzpicture}
  \end{subfigure}

\end{figure}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../robocert"
%%% End:
