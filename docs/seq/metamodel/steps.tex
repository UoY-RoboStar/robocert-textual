%!TEX root=../../robocert.tex
\begin{figure}[htb]
	\centering
	\includegraphics[width=\textwidth]{diagrams/Steps}
	\caption{Class diagram for the part of the \langname{} metamodel dealing with steps.}
	\label{fig:metamodel-steps}
\end{figure}

\noindent
Steps (\msequencestep) are elements of
\msubsequence s.  They represent both communications and control flow, and
can themselves contain \msubsequence s.  There are three types of
step:

\begin{itemize}
\item \mdeadlinestep{} (\cref{ssec:metamodel-steps-deadlines});
\item \mloopstep{} (\cref{ssec:metamodel-steps-loops});
\item \mactionstep{} (\cref{ssec:metamodel-steps-actions});
\end{itemize}

\Cref{fig:metamodel-actions} depicts the part of the metamodel concerning
sequence steps.

\subsection{\mdeadlinestep}\label{ssec:metamodel-steps-deadlines}

A \mdeadlinestep{} asserts that a \msubsequence{} takes at most
a given number of time units to complete.
It takes an expression that must
evaluate to a natural number of time units.

\begin{remark}
To specify that all actions in a \msubsequence{} must occur
immediately, use a deadline of \(0\).
\end{remark}

\begin{figure}[H]
\begin{subfigure}[t]{\egtextwidth}
\begin{lstlisting}[style=Example]
within 3 units {
    ->op O1()
}
\end{lstlisting}
\end{subfigure}
\hfill
\begin{subfigure}[t]{\eggraphicalwidth}
  \gsecaption
  \centering
  \begin{tikzpicture}
\matrix[diagram]{
  \node[rcmodule](mstart) {\egtarget}; & \node[world](wstart) {\egworld}; \\
  & \coordinate(wds); & \\
  \coordinate(mo); & \coordinate(wo); & \\
  \coordinate(mde); & \coordinate(wde); \\
};
\draw[lifeline] (mstart) -- (mo) -- (mde);
\draw[lifeline] (wstart) -- (wds) -- (wo) -- (wde);
\gdeadline{wds}{wde}{3}
\draw (mo) edge[oarrow, "O1()"] (wo);
  \end{tikzpicture}
\end{subfigure}
\end{figure}

\subsection{\mloopstep}\label{ssec:metamodel-steps-loops}

% Shorthand for introducing the loop action diagram matrix.
\newcommand{\egloopmatrix}{
  \node[rcmodule](mstart) {\egtarget}; \pgfmatrixnextcell \node[world](wstart) {\egworld}; \\
  \coordinate(mls); \pgfmatrixnextcell \coordinate(wls); \\
  \coordinate(mo); \pgfmatrixnextcell \coordinate(wo); \\
  \coordinate(mle); \pgfmatrixnextcell \coordinate(wle); \\
}
% Draws the entire loop diagram with the given loop bound header.
\newcommand{\egloopdiagram}[2]{
  \matrix[diagram]{\egloopmatrix};
  \draw[lifeline] (mstart) -- (mls) -- (mo) -- (mle);
  \draw[lifeline] (wstart) -- (wls) -- (wo) -- (wle);
  \draw (mo) edge[oarrow, "O1()"] (wo);
  \gloop{mls}{wls}{mle}{wle}{#1}{#2}
}

A \mloopstep{} is a loop over a \msubsequence{} of
steps.  The number of times a \mloopstep{} will iterate \todo{adding
  breaks will change this} depends on its attached \mloopbound{}.
Each bound is in terms of \mexpression{}s that are evaluated
\emph{only once}, before the execution of the loop.

Loops may optionally have names, which are displayed to the side of
the loop header in the graphical syntax.  Loop names will eventually
be used for break expressions.

\begin{remark}
  The textual notation examples shown below also work for unnamed
  loops, with one syntactic convenience: the \texttt{:} can be
  omitted.
  \begin{lstlisting}[language=RoboCert]
    loop: forever    { ->op O1() } // valid
    loop forever     { ->op O1() } // valid, equivalent to above
    loop L1: forever { ->op O1() } // valid
    loop L1 forever  { ->op O1() } // invalid
  \end{lstlisting}
\end{remark}

\paragraph{\minfiniteloopbound}
A \minfiniteloopbound{} states that the loop iterates an unbounded
number of times.

\begin{figure}[H]
\begin{subfigure}[t]{\egtextwidth}
\begin{lstlisting}[style=Example]
// these are equivalent:
loop L1: forever { ->op O1() }
loop L1          { ->op O1() }
\end{lstlisting}
\end{subfigure}
\hfill
\begin{subfigure}[t]{\eggraphicalwidth}
  \gsecaption
  \centering
  \begin{tikzpicture}
    \egloopdiagram{L1}{\gloopinfinite}
  \end{tikzpicture}
\end{subfigure}
\end{figure}

\paragraph{\mdefiniteloopbound}
A \mdefiniteloopbound{} states that the loop iterates exactly the
number of times given in the bound.

\begin{figure}[H]
\begin{subfigure}[t]{\egtextwidth}
\begin{lstlisting}[style=Example]
loop L2 : exactly 4 times {
    ->op O1()
}
\end{lstlisting}
\end{subfigure}
\hfill
\begin{subfigure}[t]{\eggraphicalwidth}
  \gsecaption
  \centering
  \begin{tikzpicture}
    \egloopdiagram{L2}{\gloopdefinite{4}}
  \end{tikzpicture}
\end{subfigure}
\end{figure}

\paragraph{\mlowerloopbound}
A \mlowerloopbound{} states that the loop iterates at least the
number of times given in the bound, but may nondeterministically
choose to execute any number of times in addition.

\begin{figure}[h!]
\begin{subfigure}[t]{\egtextwidth}
\begin{lstlisting}[style=Example]
loop L3 : at least 5 times {
    ->op O1()
}
\end{lstlisting}
\end{subfigure}
\hfill
\begin{subfigure}[t]{\eggraphicalwidth}
  \gsecaption
  \centering
  \begin{tikzpicture}
    \egloopdiagram{L3}{\glooplower{5}}
  \end{tikzpicture}
\end{subfigure}
\end{figure}

\paragraph{\mrangeloopbound}
A \mrangeloopbound{} behaves as a \mlowerloopbound, but states that
the loop will not iterate any more times than the given upper bound.
Note that if the bounds are the same, the semantics is equivalent
to that of a \mdefiniteloopbound{}.

\begin{figure}[H]
\begin{subfigure}[t]{\egtextwidth}
\begin{lstlisting}[style=Example]
loop L4 : between 3 and 6 times {
    ->op O1()
}
\end{lstlisting}
\end{subfigure}
\hfill
\begin{subfigure}[t]{\eggraphicalwidth}
  \gsecaption
  \centering
  \begin{tikzpicture}
    \egloopdiagram{L4}{\glooprange{3}{6}}
  \end{tikzpicture}
\end{subfigure}
\end{figure}

\subsection{\mactionstep}\label{ssec:metamodel-steps-actions}

An \mactionstep{} contains a specification of a
\msequenceaction{} (\cref{sec:metamodel-actions}), as well as
a \mmessageset{}
capturing any communications implicitly allowed to happen
in the \emph{gap} before the action.

\begin{figure}[H]
  \begin{subfigure}[c]{\egtextwidth}
    \begin{lstlisting}[style=Example]
anything in set MS except ->op O()
until ->event E

anything except ->op O() until <-event E
// shorthand for 'in {||} except ->op O2()'

anything until ->event E
// shorthand for 'in universe'
    \end{lstlisting}
  \end{subfigure}
  \hfill
  \begin{subfigure}[c]{\eggraphicalwidth}
    \gsecaption
    \centering
    \begin{tikzpicture}
      \matrix[diagram, column sep=9em]{
        \node[rcmodule](mstart) {\egtarget}; & \node[world](wstart) {\egworld}; \\
        \coordinate(m1); & \coordinate(w1); \\
        \coordinate(m2); & \coordinate(w2); \\
        \coordinate(m3); & \coordinate(w3); \\
      };

      \draw[lifeline] (mstart) -- (m1) -- (m2) -- (m3);
      \draw[lifeline] (wstart) -- (w1) -- (w2) -- (w3);
      
      \draw (m1) edge[earrow, "E"] (w1);
      \ggapout{m1}{\gdiff{\grefset{MS}}\gextset{\text{\lstinline[language=RoboCert]{->op O()}}}}
      
      \draw (w2) edge[earrow, "E"'] (m2);
      \ggapin{w2}{\gdiff{\guniverse}\gextset{\text{\lstinline[language=RoboCert]{->op O()}}}}
      
      \draw (m3) edge[earrow, "E"] (w3);
      \ggapout{m3}{\guniverse}
    \end{tikzpicture}
  \end{subfigure}
\end{figure}
%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../../robocert"
%%% End:
